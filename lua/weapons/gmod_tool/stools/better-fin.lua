TOOL.Category		= "Construction"
TOOL.Name			= "#Tool.better_fin.name"
TOOL.Command		= nil
TOOL.ConfigName		= ""

TOOL.ClientConVar = {
	coef		        = 0.5,
}

cleanup.Register( "better_fin" )

-- // Add Default Language translation (saves adding it to the txt files)
if CLIENT then
	language.Add( "Tool.better_fin.name", "Better Fin Tool" )
	language.Add( "Tool.better_fin.desc", "Make a Fin out of a physics-prop." )
	language.Add( "Tool.better_fin.0", "Left-Click to apply settings; Right-Click to copy" )
	language.Add( "Tool.better_fin.coef", "Lift coefficient of Fin:" )
	language.Add( "Undone_better_fin", "Undone Fin" )
	language.Add( "Cleanup_better_fin", "Fin" )
	language.Add( "Cleaned_better_fin", "Cleaned up all Fins" )
	language.Add( "sboxlimit_better_fin", "You've reached the Fin-limit!" )
end

if SERVER then
    CreateConVar("sbox_max_better_fin", 20)
end

function networked(Entity, Data)
    Entity:SetNWBool("Active", true)
    Entity:SetNWFloat("coefficient", Data.coefficient)
end
function networked_remove_partially(Entity)
    Entity:SetNWBool("Active", true)
    Entity:SetNWFloat("coefficient", -99)
end
function networked_remove(Entity)
    Entity:SetNWBool("Active", false)
    Entity:SetNWFloat("coefficient", -99999999)
end

if CLIENT then
    -- Print screen
    function showValuesFinHUD()
        local Player   = LocalPlayer()
        local Entity   = Player:GetEyeTrace().Entity
        local Weapon   = Player:GetActiveWeapon()
        if (!Player:IsValid() or !Entity:IsValid() or !Weapon:IsValid()) then return end
        
        local position = (Entity:LocalToWorld(Entity:OBBCenter())):ToScreen()
        
        if Weapon:GetClass() != "gmod_tool" or Player:GetInfo("gmod_toolmode") != "better_fin" then return end
        
        -- -99/nil = partially removed
        -- -99999999/-nil = undefined
        
        -- Get networked values of Entity
        local Active            = Entity:GetNWBool("Active", false)
        local coefficient         = Entity:GetNWFloat("coefficient", -99999999)
        --
        if (Active) then
            -- Display values
            if (Entity:IsValid()) then
                local on = "On"
                local off = "Off"
                
                -- Set text-string for display
                local text0     = "Effic.: "..coefficient

                -- Draw template Text for width- and height-calculations
                surface.SetFont("Trebuchet18")
                surface.SetTextColor(255, 255, 255, 0)
                surface.SetTextPos(position.x, position.y)
                surface.DrawText(text0)
                local width_text, height_text = surface.GetTextSize(text0)

                -- Text-dimensions
                local positionX_text = (position.x - (width_text / 2) - 30)
                local positionY_text = (position.y - (height_text / 2))

                -- Box-dimensions
                local width_box = width_text * 3 -- Change this value for box-size
                local height_box = height_text * 2 -- Change this value for box-size
                local positionX_box = position.x - (width_box / 2)
                local positionY_box = position.y - (height_box / 2)

                -- Draw Rounded Box
                draw.RoundedBox(3, (positionX_box * 0.994), (positionY_box * 0.99), ((width_box * 1.22) * 1.09), ((height_box * 4.5) * 1.065), Color(000, 000, 000, 197))
                draw.RoundedBox(3, positionX_box, positionY_box, (width_box * 1.22), (height_box * 4.5), Color(29, 167, 209, 197))
                -- Draw real Text
                surface.SetFont("Trebuchet18")
                surface.SetTextColor(255, 255, 255, 255)
                -- Text 0
                surface.SetTextPos(positionX_text, positionY_text)
                surface.DrawText(text0)
            end
        else return end
    end
    
    hook.Add("HUDPaint", "showValuesFinHUD", showValuesFinHUD)
end

function TOOL:LeftClick( trace )
	if (!trace.Hit or !trace.Entity:IsValid() or trace.Entity:GetClass() != "prop_physics") then return false end
	if (SERVER and !util.IsValidPhysicsObject( trace.Entity, trace.PhysicsBone )) then return false end
	if CLIENT then return true end
	
    local coef = self:GetClientNumber("coef")
	
	if (trace.Entity.better_fin_Ent != nil) then
		local Data = {
			coefficient = coef
        }
		table.Merge(trace.Entity.better_fin_Ent:GetTable(), Data)
		duplicator.StoreEntityModifier(trace.Entity, "better_fin", Data)
        
        -- Access on server- and client-side
        networked(trace.Entity, Data)
        
		return true
	end
	
	if !self:GetSWEP():CheckLimit("better_fin") then return false end
    
    local Data = {}
    Data = {
        coefficient = coef,
        pos		    = trace.Entity:WorldToLocal(trace.HitPos + trace.HitNormal * 4),
        ang		    = trace.Entity:WorldToLocalAngles(trace.HitNormal:Angle())
    }
	
	local fin = MakeBetterFinEnt(self:GetOwner(), trace.Entity, Data)
	
    -- Remove
	undo.Create("better_fin")   
        undo.AddFunction(function()
            -- Remove networked-settings for Entity
            networked_remove(trace.Entity)
        end)
        undo.AddEntity(fin)
        undo.SetPlayer(self:GetOwner())
	undo.Finish()
	
	return true
end

--Copy fin
function TOOL:RightClick( trace )
	if (trace.Entity.better_fin_Ent != nil) then
		local fin = trace.Entity.better_fin_Ent
		local ply = self:GetOwner()
        ply:ConCommand("better_fin_coef "..fin.coefficient)
		return true
	end
end

function TOOL:Reload( trace )
    if (trace.Entity.better_fin_Ent != nil) then
        trace.Entity.better_fin_Ent:Remove()
		trace.Entity.better_fin_Ent = nil
        -- Remove networked-settings for Entity
        networked_remove_partially(trace.Entity)
        
		return true
	end
end

if SERVER then
	function MakeBetterFinEnt( Player, Entity, Data )
		if !Data then return end
		if !Player:CheckLimit("better_fin") then return false end

		local fin = ents.Create( "better_fin" )
			if (Data.pos != nil) then fin:SetPos(Entity:LocalToWorld(Data.pos)) end
			fin:SetAngles(Entity:LocalToWorldAngles(Data.ang))
			fin.ent			= Entity
            fin.coefficient  = Data.coefficient
		fin:Spawn()
		fin:Activate()
        --
		fin:SetParent(Entity)
        Entity:DeleteOnRemove(fin)
        -- Set
		Entity.better_fin_Ent = fin

		duplicator.StoreEntityModifier(Entity, "better_fin", Data)
		Player:AddCount("better_fin", fin)
		Player:AddCleanup("better_fin", fin)
        
        -- Access on server- and client-side
        networked(Entity, Data)
		
		return fin
	end
	duplicator.RegisterEntityModifier("better_fin", MakeBetterFinEnt)
end


function TOOL.BuildCPanel(CPanel)
    -- Options	
	CPanel:AddControl("Header", {Text = "#Tool.better_fin.name"})
    
    CPanel:AddItem(left2, ctrl2)
    -- Slider
	CPanel:NumSlider("#Tool.better_fin.coef", "better_fin_coef", 0, 2, nil)
end